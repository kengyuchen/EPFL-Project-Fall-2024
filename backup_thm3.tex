
For $\textsf{option}$ that includes $\mathcal{O}_{\textsf{Probe}}$, we first note that the output of $\textsf{encodeEnroll}$ in Section \ref{sec:fh-IPFE-instantiation} is never a zero vector. This means for any $\mathbf{x} \getsdollar \textsf{encodeEnroll}()$ and $d \in \Z_q$, one can easily find some $\mathbf{y} \in \Z_q^{k+2}$ such that $\mathbf{x}\mathbf{y}^T = d$.

For the next theorem, we consider a tweaked probe oracle $\mathcal{O}_{\textsf{Probe}}^\textsf{tw} (\textsf{psk}, \mathbf{x}, \cdot)$.

\begin{itemize}

	\item $\mathcal{O}_{\textsf{Probe}}^\textsf{tw} (\textsf{psk}, \mathbf{x}, \cdot)$: On input $d$, it first finds $\mathbf{y}^{\prime\prime}$ such that $\mathbf{x}{\mathbf{y}^{\prime\prime}}^T = d$. Then it returns $\textsf{Probe}(\textsf{psk}, {\mathbf{y}^{\prime\prime}})$.

\end{itemize}

\begin{theorem}
\label{thm:ind-uf-lob3}

For any distribution family $\mathbb{B}$, if \textsf{FE} is fh-IND secure, then $\forall \mathcal{A}$ in the \textsf{UF-LoB} game where the auxiliary information $\textsf{option}$ includes $\mathcal{O}_\textsf{Probe}$, there exists an adversary $\mathcal{A}^\textsf{tw}$ in a $\textsf{UF-LoB}^*$ game that provides $\mathcal{O}_\textsf{Probe}^\textsf{tw}$ in $\textsf{option}$ such that
\[
	\Pr[\textsf{UF-LoB}_{\Pi, \mathbb{B}, \textsf{O}_{\textsf{Probe}}}(\mathcal{A}) \to 1] - \Pr[\textsf{UF-LoB}^*_{\Pi, \mathbb{B}, \textsf{O}_{\textsf{Probe}}^\textsf{tw} }(\mathcal{A}^\textsf{tw} ) \to 1] = \negl.
\]	

\end{theorem}


\begin{proof}
\label{proof:ind-uf-lob3}

Given an adversary $\mathcal{A}$ in the \textsf{UF-LoB} game, consider the reduction adversary $\mathcal{R}$ in Algorithm \ref{alg:reduction1-ind-uf-lob3_game} which plays the \textsf{fh-IND} game. $\mathcal{R}$ runs $\mathcal{A}$ and simulates each oracle in the following way.

\begin{itemize}
	\item $\mathcal{O}_{\textsf{samp}}(i)$: This is sampled by $\mathcal{O}_{\textsf{samp}}(i)$ of $\mathcal{R}$.
	
	\item $\mathcal{O}_{\mathcal{B}}$: This is simulated by the oracle $\mathcal{O}_{\mathcal{B}^{(0)}}$

	\item $\mathcal{O}_{\textsf{auth}}^q (\textsf{csk}, \mathbf{\tilde{c_x}}, \mathbf{\tilde{c_y}})$: This is simulated by calling $\textsf{Verify}( \textsf{FE.Dec}(\textsf{pp}, \mathbf{\tilde{c_x}}, \mathbf{\tilde{c_y}}) )$.

	\item $\mathcal{O}_{\textsf{Probe}}( \textsf{psk}, \mathbf{y}^\prime )$: It first computes $d \gets \mathbf{x}^{(0)}{\mathbf{y}^\prime}^T$, and then finds $\mathbf{y}^{\prime\prime}$ such that $\mathbf{x}^{(1)}{\mathbf{y}^{\prime\prime}}^T = d$. Next, it calls $\mathcal{O}_{\textsf{Enc}}(\mathbf{y}^\prime, {\mathbf{y}^{\prime\prime}})$, which is given by the \textsf{fh-IND} game, and returns the result.

\end{itemize}

\noindent Note that $(\mathbf{x}^{(0)}, \mathbf{x}^{(1)})$ is the only query of $\mathcal{R}$ to $\mathcal{O}_{\textsf{KeyGen}}$, and for any query $( \mathbf{y}^\prime, {\mathbf{y}^{\prime\prime}} )$ to $\mathcal{O}_{\textsf{Enc}}$, it satisfies $\mathbf{x}^{(0)}{\mathbf{y}^\prime}^T = \mathbf{x}^{(1)}{\mathbf{y}^{\prime\prime}}^T$. Hence, $\mathcal{R}$ is an admissible adversary.

\begin{figure}[h]
\centering
	
	\begin{minipage}[t]{0.5\linewidth}
	\centering
	\begin{algorithm}[H]
		\caption{$\mathcal{R}^{\mathcal{O}_{\textsf{KeyGen}}, \mathcal{O}_{\textsf{Enc}}}(\textsf{pp})$}
	\label{alg:reduction1-ind-uf-lob3_game}
	\begin{algorithmic}[1]
		\State $\mathcal{B}^{(0)} \getsdollar \mathbb{B}, \quad \mathbb{B} \gets \mathbb{B} \setminus \mathcal{B}^{(0)}$

		\State $\mathcal{B}^{(1)} \getsdollar \mathbb{B}, \quad \mathbb{B} \gets \mathbb{B} \setminus \mathcal{B}^{(1)}$

		\State $\mathbf{x}^{(0)} \gets \textsf{encodeEnroll}^{\mathcal{O}_{\mathcal{B}^{(0)}}}()$

		\State $\mathbf{x}^{(1)} \gets \textsf{encodeEnroll}^{\mathcal{O}_{\mathcal{B}^{(1)}}}()$

		\State $\mathbf{c_x} \gets \mathcal{O}_{\textsf{KeyGen}}(\mathbf{x}^{(0)}, \mathbf{x}^{(1)})$

		\State ${\mathbf{\tilde{z}}} \gets \mathcal{A}^{\mathcal{O}_{\textsf{samp}}, \mathcal{O}_{\mathcal{B}^{(0)}}, \mathcal{O}_\textsf{auth}^q, \mathcal{O}_{\textsf{Probe}} } ( \mathbf{c_x})$

		\State $s \gets \textsf{FE.Dec}( \textsf{pp}, \mathbf{c_x}, \mathbf{\tilde{z}} )$

		\If{$\textsf{Verify}(s) = 1$} \label{alg:reduction1-ind-uf-lob3_game:verify}
			\State \Return $\tilde{b} = 0$
		\Else
			\State \Return $\tilde{b} \getsdollar \{0, 1\}$
		\EndIf

	\end{algorithmic}
	\end{algorithm}
	\end{minipage}
	
\label{fig:reduction1-ind-uf-lob3_game}
\end{figure}

If the challenge bit $b = 0$, then $\mathcal{R}$ perfectly simulates a \textsf{UF-LoB} game for $\mathcal{A}$. Therefore, the probability that $\textsf{Verify}(s) = 1$ in Line \ref{alg:reduction1-ind-uf-lob3_game:verify} is $\Pr[\textsf{UF-LoB}(\mathcal{A}) \to 1]$.

	For the case when the challenge bit $b = 1$, consider an adversary $\mathcal{A}^\textsf{tw}$ in Algorithm \ref{alg:adv-tw-ind-uf-lob3_game} in the tweaked $\textsf{UF-LoB}^*$ game that provides $\mathcal{O}_\textsf{Probe}^\textsf{tw}$ instead of $\mathcal{O}_\textsf{Probe}$. The adversary $\mathcal{A}^\textsf{tw}$ runs $\mathcal{A}$ and simulates each oracle in the following way.

\begin{itemize}
	\item $\mathcal{O}_{\textsf{samp}}(i)$: This is sampled by $\mathcal{O}_{\textsf{samp}}(i)$ of $\mathcal{A}^\textsf{tw}$.
	
	\item $\mathcal{O}_{\mathcal{B}}$: This is simulated by the oracle $\mathcal{O}_{\textsf{samp}}(i^*)$, where $i^*$ is an index that is never queried by $\mathcal{A}$ in $\mathcal{O}_{\textsf{samp}}$.

	\item $\mathcal{O}_{\textsf{auth}}^q (\textsf{csk}, \mathbf{\tilde{c_x}}, \mathbf{\tilde{c_y}})$: This is simulated by calling $\textsf{Verify}( \textsf{FE.Dec}(\textsf{pp}, \mathbf{\tilde{c_x}}, \mathbf{\tilde{c_y}}) )$.

	\item $\mathcal{O}_{\textsf{Probe}}( \textsf{psk}, \mathbf{y}^\prime )$: It first computes $d \gets \mathbf{x}^{(*)}{\mathbf{y}^\prime}^T$, and then it calls $\mathcal{O}_{\textsf{Probe}}^\textsf{tw} (\textsf{psk}, \mathbf{x}, d)$ , which is given by the tweaked $\textsf{UF-LoB}^*$ game, and returns the result.

\end{itemize}

\begin{figure}[h]
\centering
	
	\begin{minipage}[t]{0.5\linewidth}
	\centering
	\begin{algorithm}[H]
	\caption{${\mathcal{A}^\textsf{tw}}^{\mathcal{O}_\textsf{samp}, \mathcal{O}_\textsf{auth}^q, \mathcal{O}_{\textsf{Probe}}^\textsf{tw} } ( \mathbf{c_x}) $}
	\label{alg:adv-tw-ind-uf-lob3_game}
	\begin{algorithmic}[1]
		\State $\mathbf{x}^{(*)} \gets \textsf{encodeEnroll}^{ \mathcal{O}_\textsf{samp}(i^*)} ()$ 

		\State ${\mathbf{\tilde{z}}} \gets \mathcal{A}^{\mathcal{O}_{\textsf{samp}}, \mathcal{O}_{\textsf{samp}}(i^*), \mathcal{O}_\textsf{auth}^q, \mathcal{O}_{\textsf{Probe}} } ( \mathbf{c_x})$

		\State \Return ${\mathbf{\tilde{z}}}$
	\end{algorithmic}
	\end{algorithm}
	\end{minipage}
	
\label{fig:adv-tw-ind-uf-lob3_game}
\end{figure}

Now, if the challenge bit $b = 1$, then $\mathcal{R}$ perfectly simulates $\mathcal{A}^\textsf{tw}$ in this tweaked $\textsf{UF-LoB}^*$ game. 
The probability that $\textsf{Verify}(s) = 1$ in Line \ref{alg:reduction1-ind-uf-lob3_game:verify} is $\Pr[ \textsf{UF-LoB}_{\mathcal{O}_\textsf{Probe}^\textsf{tw}}^*(\mathcal{A}^\textsf{tw}) \to 1 ]$.
Similar to the proof of Theorem \ref{thm:ind-uf-lob1}, we derive
\[
	\Pr[\textsf{fh-IND}(\mathcal{R}) \to 1]
	= \frac{1}{2} + \frac{1}{4} \left( \Pr[\textsf{UF-LoB}_{\mathcal{O}_\textsf{Probe}}(\mathcal{A}) \to 1] - \Pr[ \textsf{UF-LoB}_{\mathcal{O}_\textsf{Probe}^\textsf{tw}}^*(\mathcal{A}^\textsf{tw}) \to 1 ] \right)
\]

Therefore,

\[
	\Pr[\textsf{UF-LoB}_{\Pi, \mathbb{B}, \textsf{O}_{\textsf{Probe}}}(\mathcal{A}) \to 1] - \Pr[\textsf{UF-LoB}^*_{\Pi, \mathbb{B}, \textsf{O}_{\textsf{Probe}}^\textsf{tw} }(\mathcal{A}^\textsf{tw} ) \to 1] = 4 \cdot \Adv_{\textsf{FE}, \mathcal{R}}^\textsf{fh-IND} = \negl.
\]	


\end{proof}
